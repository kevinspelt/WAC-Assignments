<!DOCTYPE html>
<html lang="en">
<head>
    <meta  charset="UTF-8" name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Title</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/2.8.0/css/flag-icon.min.css">
</head>
<body>

<div id="frame">

    <div id="myLocation" class="info">
        <h1>Mijn Locatie</h1>
        <table>
            <tr>
                <td>Country:</td>
                <td class="dataIP" id="country_name"></td>
            </tr>
            <tr>
                <td>Country Code:</td>
                <td class="dataIP" id="country"></td>
            </tr>
            <tr>
                <td>Region:</td>
                <td class="dataIP" id="region"></td>
            </tr>
            <tr>
                <td>City:</td>
                <td class="dataIP" id="city"></td>
            </tr>
            <tr>
                <td>Postal:</td>
                <td class="dataIP" id="postal"></td>
            </tr>
            <tr>
                <td>Latitude:</td>
                <td class="dataIP" id="latitude"></td>
            </tr>
            <tr>
                <td>Longitude:</td>
                <td class="dataIP" id="longitude"></td>
            </tr>
            <tr>
                <td>IP:</td>
                <td class="dataIP" id="ip"></td>
            </tr>
        </table>
    </div>

    <div id="weatherInfo" class="info">
        <h1 id="weatherHeader"></h1>
        <table>
            <tr>
                <td>Temperature:</td>
                <td class="dataWeather" id="main.temp"></td>
            </tr>
            <tr>
                <td>Humidity:</td>
                <td class="dataWeather" id="main.humidity"></td>
            </tr>
            <tr>
                <td>Wind Speed:</td>
                <td class="dataWeather" id="wind.speed"></td>
            </tr>
            <tr>
                <td>Wind Degree:</td>
                <td class="dataWeather" id="wind.deg"></td>
            </tr>
            <tr>
                <td>Sunrise:</td>
                <td class="dataWeather" id="sys.sunrise"></td>
            </tr>
            <tr>
                <td>Sunset:</td>
                <td class="dataWeather" id="sys.sunset"></td>
            </tr>
        </table>
    </div>

    <div id="countryList" class="data">
        <h1>Beschikbare vakantiebestemmingen</h1>
        <table id="countryTable">
            <thead>
                <th>Flag</th>
                <th>Country</th>
                <th>Capital</th>
                <th>Region</th>
                <th>Surface</th>
                <th>Population</th>
            </thead>

            <tbody id="countries">

            </tbody>
        </table>
    </div>

</div>

<script>
    function initPage() {
        fetch("https://ipapi.co/json/")
            .then(response => response.json())
            .then(function (myJson) {
                const dataIP = document.querySelectorAll("td.dataIP");

                for(let i = 0; i < dataIP.length; i++) {
                    const td = dataIP[i];
                    td.textContent = myJson[td.id];

                    if(td.id === "city") {
                        td.addEventListener("click", function () {
                            showWeather(myJson.longitude, myJson.latitude, myJson.city);
                        })
                    }
                }

                showWeather(myJson.longitude, myJson.latitude, myJson.city);
                loadCountries();
            });
    }

    function showWeather(longitude, latitude, city) {
        const dataWeather = document.querySelectorAll("td.dataWeather");
        const weatherHeader = document.querySelector("#weatherHeader");

        weatherHeader.textContent = "Het weer in " + city;

        if(window.localStorage.getItem(city) === null) {
            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&q=${city}&units=metric&appid=3b0d963e4598d465a0b3926b905c7cf1`)
                .then(response => response.json())
                .then(function (myJson) {
                    for(let i = 0; i < dataWeather.length; i++) {
                        const td = dataWeather[i];
                        const parts = td.id.split(".");
                        td.textContent = myJson[parts[0]][parts[1]];
                    }
                    myJson.timestamp = Date.now();
                    window.localStorage.setItem(city, JSON.stringify(myJson));
                });
        } else if(Date.now() - window.localStorage.getItem(city).timestamp > 600) {
            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&q=${city}&units=metric&appid=3b0d963e4598d465a0b3926b905c7cf1`)
                .then(response => response.json())
                .then(function (myJson) {
                    for(let i = 0; i < dataWeather.length; i++) {
                        const td = dataWeather[i];
                        const parts = td.id.split(".");
                        td.textContent = myJson[parts[0]][parts[1]];
                    }
                    myJson.timestamp = Date.now();
                    window.localStorage.setItem(city, JSON.stringify(myJson));
                });
        } else {
            const country = JSON.parse(window.localStorage.getItem(city));
            for(let i = 0; i < dataWeather.length; i++) {
                const td = dataWeather[i];
                const parts = td.id.split(".");
                console.log(country[parts[0]][parts[1]]);
                td.textContent = country[parts[0]][parts[1]];
            }
        }
    }

    function loadCountries() {
        fetch("http://localhost:1337/restservices/countries")
            .then(response => response.json())
            .then(function (myJson) {
                const countryList = document.querySelector("#countryList");
                const countryTable = countryList.querySelector("#countryTable");
                const countryTBody = countryTable.querySelector("#countries");

                for (const country of myJson) {
                    const ph = document.createElement("tr");

                    const vlag = document.createElement("td");
                    const land = document.createElement("td");
                    const hoofdstad = document.createElement("td");
                    const regio = document.createElement("td");
                    const oppervlakte = document.createElement("td");
                    const inwoners = document.createElement("td");

                    const span = vlag.appendChild(document.createElement("span"));
                    span.setAttribute("id", "flag");
                    span.setAttribute("class", "flag-icon flag-icon-" + country.code.toLowerCase());

                    land.appendChild(document.createTextNode(country.name));
                    hoofdstad.appendChild(document.createTextNode(country.capital));
                    regio.appendChild(document.createTextNode(country.region));
                    oppervlakte.appendChild(document.createTextNode(country.surface));
                    inwoners.appendChild(document.createTextNode(country.population));

                    ph.appendChild(vlag);
                    ph.appendChild(land);
                    ph.appendChild(hoofdstad);
                    ph.appendChild(regio);
                    ph.appendChild(oppervlakte);
                    ph.appendChild(inwoners);

                    ph.addEventListener("click", function () {
                        showWeather(country.lng, country.lat, country.capital);
                    });

                    countryTBody.appendChild(ph);
                }
            });
    }
    initPage();
</script>

</body>
</html>
